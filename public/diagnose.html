<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç³»ç»Ÿè¯Šæ–­å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 30px;
    }
    h1 {
      margin-bottom: 20px;
      color: #333;
    }
    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
    }
    .test-section h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #555;
    }
    button {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #5568d3;
    }
    .result {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      display: none;
    }
    .result.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .result.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .result.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 10px;
    }
    .status.ok {
      background: #d4edda;
      color: #155724;
    }
    .status.fail {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” ç³»ç»Ÿè¯Šæ–­å·¥å…·</h1>
    <p style="margin-bottom: 20px; color: #666;">ç”¨äºè¯Šæ–­ Cloudflare Pages Functions é…ç½®é—®é¢˜</p>

    <!-- æµ‹è¯• 1: æ£€æŸ¥ API å¯è®¿é—®æ€§ -->
    <div class="test-section">
      <h2>æµ‹è¯• 1: API å¯è®¿é—®æ€§ <span id="test1-status" class="status">å¾…æµ‹è¯•</span></h2>
      <button onclick="testAPI()">æµ‹è¯• API ç«¯ç‚¹</button>
      <div id="test1-result" class="result"></div>
    </div>

    <!-- æµ‹è¯• 2: æµ‹è¯• D1 æ•°æ®åº“ -->
    <div class="test-section">
      <h2>æµ‹è¯• 2: D1 æ•°æ®åº“è¿æ¥ <span id="test2-status" class="status">å¾…æµ‹è¯•</span></h2>
      <button onclick="testD1()">æµ‹è¯•æ•°æ®åº“</button>
      <div id="test2-result" class="result"></div>
    </div>

    <!-- æµ‹è¯• 3: æµ‹è¯•å¯†ç éªŒè¯ -->
    <div class="test-section">
      <h2>æµ‹è¯• 3: å¯†ç éªŒè¯ <span id="test3-status" class="status">å¾…æµ‹è¯•</span></h2>
      <div style="margin-bottom: 10px;">
        <input type="password" id="testPassword" placeholder="è¾“å…¥å¯†ç " style="padding: 8px; width: 200px;">
      </div>
      <button onclick="testPassword()">éªŒè¯å¯†ç </button>
      <div id="test3-result" class="result"></div>
    </div>

    <!-- æµ‹è¯• 4: ç¯å¢ƒç»‘å®šæ£€æŸ¥ -->
    <div class="test-section">
      <h2>æµ‹è¯• 4: ç¯å¢ƒç»‘å®šæ£€æŸ¥ <span id="test4-status" class="status">å¾…æµ‹è¯•</span></h2>
      <button onclick="testBindings()">æ£€æŸ¥ç»‘å®š</button>
      <div id="test4-result" class="result"></div>
    </div>

    <!-- æµ‹è¯• 5: å°è¯•æ·»åŠ æ•°æ® -->
    <div class="test-section">
      <h2>æµ‹è¯• 5: æ·»åŠ æµ‹è¯•æ•°æ® <span id="test5-status" class="status">å¾…æµ‹è¯•</span></h2>
      <button onclick="testAddData()">æ·»åŠ æµ‹è¯•ç½‘ç«™</button>
      <div id="test5-result" class="result"></div>
    </div>
  </div>

  <script>
    const apiUrl = window.location.origin;

    function showResult(id, text, type) {
      const el = document.getElementById(id);
      el.textContent = text;
      el.className = `result ${type}`;
      el.style.display = 'block';
    }

    function setStatus(id, status) {
      const el = document.getElementById(id);
      el.className = `status ${status ? 'ok' : 'fail'}`;
      el.textContent = status ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥';
    }

    async function testAPI() {
      try {
        const response = await fetch(`${apiUrl}/api/websites/read`);
        const data = await response.json();

        showResult('test1-result', `âœ… API å¯è®¿é—®\n\nè¿”å›æ•°æ®:\n${JSON.stringify(data, null, 2)}`, 'success');
        setStatus('test1-status', true);
      } catch (error) {
        showResult('test1-result', `âŒ API è®¿é—®å¤±è´¥\n\né”™è¯¯: ${error.message}`, 'error');
        setStatus('test1-status', false);
      }
    }

    async function testD1() {
      try {
        const response = await fetch(`${apiUrl}/api/websites/read`);
        const data = await response.json();

        if (data.navItems && Array.isArray(data.navItems)) {
          showResult('test2-result', `âœ… D1 æ•°æ®åº“æ­£å¸¸\n\næ•°æ®è¡¨å·²åˆ›å»º\nå½“å‰ç½‘ç«™æ•°é‡: ${data.navItems.length} ä¸ªåˆ†ç±»`, 'success');
          setStatus('test2-status', true);
        } else {
          showResult('test2-result', `âš ï¸ API è¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸\n\n${JSON.stringify(data, null, 2)}`, 'info');
          setStatus('test2-status', false);
        }
      } catch (error) {
        showResult('test2-result', `âŒ æ•°æ®åº“è¿æ¥å¤±è´¥\n\né”™è¯¯: ${error.message}\n\nå¯èƒ½åŸå› ï¼š\n1. D1 æ•°æ®åº“è¡¨æœªåˆ›å»º\n2. wrangler.toml é…ç½®é”™è¯¯\n3. D1 ç»‘å®šå¤±è´¥`, 'error');
        setStatus('test2-status', false);
      }
    }

    async function testPassword() {
      const password = document.getElementById('testPassword').value;

      if (!password) {
        showResult('test3-result', 'âŒ è¯·è¾“å…¥å¯†ç ', 'error');
        return;
      }

      try {
        const response = await fetch(`${apiUrl}/api/private/verify`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ password })
        });
        const data = await response.json();

        if (response.ok && data.success) {
          showResult('test3-result', 'âœ… å¯†ç éªŒè¯æˆåŠŸ\n\nç¯å¢ƒå˜é‡ PRIVATE_PASSWORD å·²æ­£ç¡®è®¾ç½®', 'success');
          setStatus('test3-status', true);
        } else {
          showResult('test3-result', `âŒ å¯†ç éªŒè¯å¤±è´¥\n\nçŠ¶æ€ç : ${response.status}\nè¿”å›: ${JSON.stringify(data, null, 2)}`, 'error');
          setStatus('test3-status', false);
        }
      } catch (error) {
        showResult('test3-result', `âŒ è¯·æ±‚å¤±è´¥\n\né”™è¯¯: ${error.message}\n\nå¯èƒ½åŸå› ï¼š\n1. ç¯å¢ƒå˜é‡ PRIVATE_PASSWORD æœªè®¾ç½®\n2. éƒ¨ç½²åæœªé‡æ–°éƒ¨ç½²`, 'error');
        setStatus('test3-status', false);
      }
    }

    async function testBindings() {
      try {
        const response = await fetch(`${apiUrl}/api/debug/env`);
        const data = await response.json();

        let report = 'ğŸ” ç¯å¢ƒç»‘å®šæ£€æŸ¥ç»“æœ\n\n';
        report += `ç»‘å®šçŠ¶æ€:\n`;
        report += `  DB: ${data.bindings.DB ? 'âœ… å·²ç»‘å®š' : 'âŒ æœªç»‘å®š'}\n`;
        report += `  NAV_KV: ${data.bindings.NAV_KV ? 'âœ… å·²ç»‘å®š' : 'âŒ æœªç»‘å®š'}\n`;
        report += `  PRIVATE_PASSWORD: ${data.bindings.PRIVATE_PASSWORD ? 'âœ… å·²è®¾ç½®' : 'âŒ æœªè®¾ç½®'}\n\n`;

        report += `D1 æ•°æ®åº“æµ‹è¯•:\n`;
        if (data.testDB) {
          if (data.testDB.status === 'ok') {
            report += `  âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸\n`;
            report += `  è¡¨ä¸­è®°å½•æ•°: ${data.testDB.count}\n`;
          } else if (data.testDB.status === 'error') {
            report += `  âš ï¸ é”™è¯¯: ${data.testDB.message}\n`;
          } else if (data.testDB.status === 'not_bound') {
            report += `  âŒ ${data.testDB.message}\n`;
          }
        }

        report += `\nKV å­˜å‚¨æµ‹è¯•:\n`;
        if (data.testKV) {
          if (data.testKV.status === 'ok') {
            report += `  âœ… KV è¿æ¥æ­£å¸¸\n`;
          } else if (data.testKV.status === 'error') {
            report += `  âš ï¸ é”™è¯¯: ${data.testKV.message}\n`;
          } else if (data.testKV.status === 'not_bound') {
            report += `  âŒ ${data.testKV.message}\n`;
          }
        }

        const allBindingsOk = data.bindings.DB && data.bindings.NAV_KV && data.bindings.PRIVATE_PASSWORD;
        const dbOk = data.testDB?.status === 'ok';

        showResult('test4-result', report, allBindingsOk && dbOk ? 'success' : 'error');
        setStatus('test4-status', allBindingsOk && dbOk);

      } catch (error) {
        showResult('test4-result', `âŒ æ£€æŸ¥å¤±è´¥\n\né”™è¯¯: ${error.message}`, 'error');
        setStatus('test4-status', false);
      }
    }

    async function testAddData() {
      try {
        const response = await fetch(`${apiUrl}/api/websites/add`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${document.getElementById('testPassword').value}`
          },
          body: JSON.stringify({
            name: 'æµ‹è¯•ç½‘ç«™-' + Date.now(),
            url: 'https://example.com/' + Date.now(),
            category: 'å¼€å‘å·¥å…·',
            desc: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç½‘ç«™'
          })
        });
        const data = await response.json();

        if (response.ok && data.success) {
          showResult('test5-result', `âœ… æ•°æ®æ·»åŠ æˆåŠŸ\n\nID: ${data.id}\næ¶ˆæ¯: ${data.message}`, 'success');
          setStatus('test5-status', true);
        } else {
          showResult('test5-result', `âš ï¸ æ·»åŠ å¤±è´¥\n\nçŠ¶æ€ç : ${response.status}\nè¿”å›: ${JSON.stringify(data, null, 2)}\n\næ³¨æ„ï¼š409 è¡¨ç¤ºç½‘å€å·²å­˜åœ¨ï¼ˆæ­£å¸¸ï¼‰`, 'info');
          setStatus('test5-status', response.status === 409);
        }
      } catch (error) {
        showResult('test5-result', `âŒ æ·»åŠ å¤±è´¥\n\né”™è¯¯: ${error.message}`, 'error');
        setStatus('test5-status', false);
      }
    }
  </script>
</body>
</html>
