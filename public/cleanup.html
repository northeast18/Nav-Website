<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¸…ç†é‡å¤æ•°æ®</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 30px;
    }
    h1 {
      margin-bottom: 20px;
      color: #333;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
    }
    button {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    button:hover {
      background: #5568d3;
    }
    button.danger {
      background: #ef4444;
    }
    button.danger:hover {
      background: #dc2626;
    }
    .result {
      margin-top: 15px;
      padding: 15px;
      border-radius: 4px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .result.success {
      background: #d4edda;
      color: #155724;
    }
    .result.error {
      background: #f8d7da;
      color: #721c24;
    }
    .result.info {
      background: #d1ecf1;
      color: #0c5460;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
    }
    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #f5f5f5;
      font-weight: 600;
    }
    .duplicate {
      background: #fee;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§¹ æ•°æ®æ¸…ç†å·¥å…·</h1>

    <div class="warning">
      <strong>âš ï¸ æ³¨æ„</strong><br>
      æ­¤å·¥å…·ä¼šæ£€æŸ¥å¹¶æ¸…ç†æ•°æ®åº“ä¸­çš„é‡å¤æ•°æ®ã€‚æ“ä½œä¸å¯é€†ï¼Œè¯·è°¨æ…ä½¿ç”¨ï¼
    </div>

    <!-- æ£€æŸ¥é‡å¤ -->
    <div class="section">
      <h2>1. æ£€æŸ¥é‡å¤æ•°æ®</h2>
      <p style="margin-bottom: 10px; color: #666; font-size: 14px;">
        æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰é‡å¤çš„ç½‘å€
      </p>
      <button onclick="checkDuplicates()">æ£€æŸ¥é‡å¤</button>
      <div id="checkResult" class="result" style="display: none;"></div>
    </div>

    <!-- æŸ¥çœ‹æ‰€æœ‰æ•°æ® -->
    <div class="section">
      <h2>2. æŸ¥çœ‹æ‰€æœ‰æ•°æ®</h2>
      <p style="margin-bottom: 10px; color: #666; font-size: 14px;">
        æ˜¾ç¤ºæ•°æ®åº“ä¸­çš„æ‰€æœ‰è®°å½•
      </p>
      <button onclick="showAllData()">æ˜¾ç¤ºæ‰€æœ‰æ•°æ®</button>
      <div id="dataResult" style="display: none;"></div>
    </div>

    <!-- æ¸…ç†é‡å¤ -->
    <div class="section">
      <h2>3. æ¸…ç†é‡å¤æ•°æ®</h2>
      <p style="margin-bottom: 10px; color: #666; font-size: 14px;">
        ä¿ç•™æ¯ä¸ª URL çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œåˆ é™¤å…¶ä»–é‡å¤é¡¹
      </p>
      <button class="danger" onclick="cleanupDuplicates()">æ¸…ç†é‡å¤</button>
      <div id="cleanupResult" class="result" style="display: none;"></div>
    </div>

    <!-- æ¸…ç©ºæ‰€æœ‰ -->
    <div class="section">
      <h2>4. æ¸…ç©ºæ‰€æœ‰æ•°æ®</h2>
      <p style="margin-bottom: 10px; color: #666; font-size: 14px;">
        åˆ é™¤æ•°æ®åº“ä¸­çš„æ‰€æœ‰è®°å½•ï¼ˆå±é™©æ“ä½œï¼ï¼‰
      </p>
      <button class="danger" onclick="clearAll()">æ¸…ç©ºæ•°æ®åº“</button>
      <div id="clearResult" class="result" style="display: none;"></div>
    </div>
  </div>

  <script>
    const apiUrl = window.location.origin;

    async function checkDuplicates() {
      try {
        const response = await fetch(`${apiUrl}/api/websites/read`);
        const data = await response.json();

        if (!data.navItems) {
          throw new Error('æ— æ³•è·å–æ•°æ®');
        }

        // æ‰å¹³åŒ–æ‰€æœ‰é¡¹ç›®
        const allItems = [];
        data.navItems.forEach(category => {
          category.items.forEach(item => {
            allItems.push({
              id: item.id,
              name: item.name,
              url: item.url,
              category: category.category
            });
          });
        });

        // æ£€æŸ¥é‡å¤çš„ URL
        const urlMap = {};
        const duplicates = [];

        allItems.forEach(item => {
          if (urlMap[item.url]) {
            urlMap[item.url].push(item);
          } else {
            urlMap[item.url] = [item];
          }
        });

        Object.keys(urlMap).forEach(url => {
          if (urlMap[url].length > 1) {
            duplicates.push({ url, items: urlMap[url] });
          }
        });

        let result = '';
        if (duplicates.length === 0) {
          result = `âœ… æ²¡æœ‰å‘ç°é‡å¤æ•°æ®\n\næ€»è®°å½•æ•°: ${allItems.length}`;
        } else {
          result = `âš ï¸ å‘ç° ${duplicates.length} ä¸ªé‡å¤çš„ç½‘å€:\n\n`;
          duplicates.forEach(dup => {
            result += `URL: ${dup.url}\n`;
            result += `  é‡å¤ ${dup.items.length} æ¬¡ï¼ŒID: `;
            result += dup.items.map(i => i.id).join(', ') + '\n';
            result += `  åˆ†ç±»: ${dup.items.map(i => i.category).join(', ')}\n\n`;
          });
        }

        showResult('checkResult', result, duplicates.length === 0 ? 'success' : 'info');
      } catch (error) {
        showResult('checkResult', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function showAllData() {
      try {
        const response = await fetch(`${apiUrl}/api/websites/read`);
        const data = await response.json();

        if (!data.navItems) {
          throw new Error('æ— æ³•è·å–æ•°æ®');
        }

        // æ‰å¹³åŒ–æ‰€æœ‰é¡¹ç›®
        const allItems = [];
        data.navItems.forEach(category => {
          category.items.forEach(item => {
            allItems.push({
              id: item.id,
              name: item.name,
              url: item.url,
              category: category.category
            });
          });
        });

        let html = `
          <div style="margin-top: 15px;">
            <p><strong>æ€»è®°å½•æ•°: ${allItems.length}</strong></p>
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>åç§°</th>
                  <th>URL</th>
                  <th>åˆ†ç±»</th>
                </tr>
              </thead>
              <tbody>
        `;

        allItems.forEach(item => {
          html += `
            <tr>
              <td>${item.id}</td>
              <td>${item.name}</td>
              <td>${item.url}</td>
              <td>${item.category}</td>
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
          </div>
        `;

        const div = document.getElementById('dataResult');
        div.innerHTML = html;
        div.style.display = 'block';
      } catch (error) {
        const div = document.getElementById('dataResult');
        div.innerHTML = `<p style="color: red;">âŒ é”™è¯¯: ${error.message}</p>`;
        div.style.display = 'block';
      }
    }

    async function cleanupDuplicates() {
      if (!confirm('ç¡®å®šè¦æ¸…ç†é‡å¤æ•°æ®å—ï¼Ÿ\n\nè¿™å°†ä¿ç•™æ¯ä¸ª URL çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œåˆ é™¤å…¶ä»–é‡å¤é¡¹ã€‚')) {
        return;
      }

      try {
        const response = await fetch(`${apiUrl}/api/debug/cleanup`, {
          method: 'POST'
        });

        const result = await response.json();

        if (response.ok && result.success) {
          showResult('cleanupResult',
            `âœ… æ¸…ç†å®Œæˆ\n\n` +
            `åŸå§‹è®°å½•æ•°: ${result.beforeCount}\n` +
            `åˆ é™¤è®°å½•æ•°: ${result.deletedCount}\n` +
            `å½“å‰è®°å½•æ•°: ${result.afterCount}`,
            'success'
          );
        } else {
          showResult('cleanupResult',
            `âš ï¸ æ¸…ç†å¤±è´¥\n\n` +
            `${JSON.stringify(result, null, 2)}`,
            'error'
          );
        }
      } catch (error) {
        showResult('cleanupResult', `âŒ æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function clearAll() {
      const password = prompt('âš ï¸ å±é™©æ“ä½œï¼\n\nè¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥ç¡®è®¤æ¸…ç©ºæ•°æ®åº“:');

      if (!password) {
        return;
      }

      if (!confirm('âš ï¸âš ï¸âš ï¸ æœ€åè­¦å‘Šï¼\n\nè¿™å°†åˆ é™¤æ•°æ®åº“ä¸­çš„æ‰€æœ‰è®°å½•ï¼Œæ“ä½œä¸å¯é€†ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
        return;
      }

      try {
        const response = await fetch(`${apiUrl}/api/debug/clear`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${password}`
          }
        });

        const result = await response.json();

        if (response.ok && result.success) {
          showResult('clearResult',
            `âœ… æ•°æ®åº“å·²æ¸…ç©º\n\n` +
            `åˆ é™¤è®°å½•æ•°: ${result.deletedCount}\n\n` +
            `è¯·é‡æ–°è¿è¡Œ /migrate.html å¯¼å…¥æ•°æ®`,
            'success'
          );
        } else {
          showResult('clearResult',
            `âš ï¸ æ¸…ç©ºå¤±è´¥\n\n` +
            `çŠ¶æ€ç : ${response.status}\n` +
            `${JSON.stringify(result, null, 2)}`,
            'error'
          );
        }
      } catch (error) {
        showResult('clearResult', `âŒ æ¸…ç©ºå¤±è´¥: ${error.message}`, 'error');
      }
    }

    function showResult(id, text, type) {
      const el = document.getElementById(id);
      el.textContent = text;
      el.className = `result ${type}`;
      el.style.display = 'block';
    }
  </script>
</body>
</html>
